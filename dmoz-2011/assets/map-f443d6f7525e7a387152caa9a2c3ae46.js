/**
 * jQuery gMap
 *
 * @url		http://gmap.nurtext.de/
 * @author	Cedric Kastner <cedric@nur-text.de>
 * @version	1.1.0
 */
function MarkerManager(a,b){var c=this;c.map_=a,c.mapZoom_=a.getZoom(),c.projection_=a.getCurrentMapType().getProjection(),b=b||{},c.tileSize_=MarkerManager.DEFAULT_TILE_SIZE_;var d=MarkerManager.DEFAULT_MAX_ZOOM_;b.maxZoom!=undefined&&(d=b.maxZoom),c.maxZoom_=d,c.trackMarkers_=b.trackMarkers;var e;typeof b.borderPadding=="number"?e=b.borderPadding:e=MarkerManager.DEFAULT_BORDER_PADDING_,c.swPadding_=new GSize(-e,e),c.nePadding_=new GSize(e,-e),c.borderPadding_=e,c.gridWidth_=[],c.grid_=[],c.grid_[d]=[],c.numMarkers_=[],c.numMarkers_[d]=0,GEvent.bind(a,"moveend",c,c.onMapMoveEnd_),c.removeOverlay_=function(b){a.removeOverlay(b),c.shownMarkers_--},c.addOverlay_=function(b){a.addOverlay(b),c.shownMarkers_++},c.resetManager_(),c.shownMarkers_=0,c.shownBounds_=c.getMapGridBounds_()}function map(){$("#map").length&&$("#map").gMap({latitude:40,longitude:-40,zoom:2,controls:["GLargeMapControl3D","GMenuMapTypeControl"],scrollwheel:!1,markers:$.parseJSON($("#map").attr("data-markers"))})}(function($){$.fn.gMap=function(options){if(!window.GBrowserIsCompatible||!GBrowserIsCompatible())return this;var opts=$.extend({},$.fn.gMap.defaults,options);return this.each(function(){$gmap=new GMap2(this),$geocoder=new GClientGeocoder,opts.address?$geocoder.getLatLng(opts.address,function(a){$gmap.setCenter(a,opts.zoom)}):opts.latitude&&opts.longitude?$gmap.setCenter(new GLatLng(opts.latitude,opts.longitude),opts.zoom):$.isArray(opts.markers)&&opts.markers.length>0?opts.markers[0].address?$geocoder.getLatLng(opts.markers[0].address,function(a){$gmap.setCenter(a,opts.zoom)}):$gmap.setCenter(new GLatLng(opts.markers[0].latitude,opts.markers[0].longitude),opts.zoom):$gmap.setCenter(new GLatLng(34.885931,9.84375),opts.zoom),$gmap.setMapType(opts.maptype);if(opts.controls.length==0)$gmap.setUIToDefault();else for(var i=0;i<opts.controls.length;i++)eval("$gmap.addControl(new "+opts.controls[i]+"());");opts.scrollwheel==!0&&opts.controls.length!=0&&$gmap.enableScrollWheelZoom(),$mgr=new MarkerManager($gmap);for(var j=0;j<opts.markers.length;j++)marker=opts.markers[j],gicon=new GIcon,gicon.image=opts.icon.image,gicon.shadow=opts.icon.shadow,gicon.iconSize=$.isArray(opts.icon.iconsize)?new GSize(opts.icon.iconsize[0],opts.icon.iconsize[1]):opts.icon.iconsize,gicon.shadowSize=$.isArray(opts.icon.shadowsize)?new GSize(opts.icon.shadowsize[0],opts.icon.shadowsize[1]):opts.icon.shadowsize,gicon.iconAnchor=$.isArray(opts.icon.iconanchor)?new GPoint(opts.icon.iconanchor[0],opts.icon.iconanchor[1]):opts.icon.iconanchor,gicon.infoWindowAnchor=$.isArray(opts.icon.infowindowanchor)?new GPoint(opts.icon.infowindowanchor[0],opts.icon.infowindowanchor[1]):opts.icon.infowindowanchor,marker.icon&&(gicon.image=marker.icon.image,gicon.shadow=marker.icon.shadow,gicon.iconSize=$.isArray(marker.icon.iconsize)?new GSize(marker.icon.iconsize[0],marker.icon.iconsize[1]):marker.icon.iconsize,gicon.shadowSize=$.isArray(marker.icon.shadowsize)?new GSize(marker.icon.shadowsize[0],marker.icon.shadowsize[1]):marker.icon.shadowsize,gicon.iconAnchor=$.isArray(marker.icon.iconanchor)?new GPoint(marker.icon.iconanchor[0],marker.icon.iconanchor[1]):marker.icon.iconanchor,gicon.infoWindowAnchor=$.isArray(marker.icon.infowindowanchor)?new GPoint(marker.icon.infowindowanchor[0],marker.icon.infowindowanchor[1]):marker.icon.infowindowanchor),marker.address?(marker.html=="_address"&&(marker.html=marker.address),$geocoder.getLatLng(marker.address,function(a,b){return function(c){gmarker=new GMarker(c,a),b.html&&gmarker.bindInfoWindowHtml(opts.html_prepend+b.html+opts.html_append),b.html&&b.popup&&gmarker.openInfoWindowHtml(opts.html_prepend+b.html+opts.html_append),gmarker&&$mgr.addMarker(gmarker,b.zoom||0)}}(gicon,marker))):(marker.html=="_latlng"&&(marker.html=marker.latitude+", "+marker.longitude),gmarker=new GMarker(new GPoint(marker.longitude,marker.latitude),gicon),marker.html&&gmarker.bindInfoWindowHtml(opts.html_prepend+marker.html+opts.html_append),marker.html&&marker.popup&&gmarker.openInfoWindowHtml(opts.html_prepend+marker.html+opts.html_append),gmarker&&$mgr.addMarker(gmarker,marker.zoom||0));$mgr.refresh()})},$.fn.gMap.defaults={address:"",latitude:0,longitude:0,zoom:1,markers:[],controls:[],scrollwheel:!0,maptype:G_NORMAL_MAP,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",shadow:"http://www.google.com/mapfiles/shadow50.png",iconsize:[20,34],shadowsize:[37,34],iconanchor:[9,34],infowindowanchor:[9,2]}}})(jQuery),MarkerManager.DEFAULT_TILE_SIZE_=1024,MarkerManager.DEFAULT_MAX_ZOOM_=17,MarkerManager.DEFAULT_BORDER_PADDING_=100,MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE=256,MarkerManager.prototype.resetManager_=function(){var a=this,b=MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE;for(var c=0;c<=a.maxZoom_;++c)a.grid_[c]=[],a.numMarkers_[c]=0,a.gridWidth_[c]=Math.ceil(b/a.tileSize_),b<<=1},MarkerManager.prototype.clearMarkers=function(){var a=this;a.processAll_(a.shownBounds_,a.removeOverlay_),a.resetManager_()},MarkerManager.prototype.getTilePoint_=function(a,b,c){var d=this.projection_.fromLatLngToPixel(a,b);return new GPoint(Math.floor((d.x+c.width)/this.tileSize_),Math.floor((d.y+c.height)/this.tileSize_))},MarkerManager.prototype.addMarkerBatch_=function(a,b,c){var d=a.getPoint();this.trackMarkers_&&GEvent.bind(a,"changed",this,this.onMarkerMoved_);var e=this.getTilePoint_(d,c,GSize.ZERO);for(var f=c;f>=b;f--){var g=this.getGridCellCreate_(e.x,e.y,f);g.push(a),e.x=e.x>>1,e.y=e.y>>1}},MarkerManager.prototype.isGridPointVisible_=function(a){var b=this,c=b.shownBounds_.minY<=a.y&&a.y<=b.shownBounds_.maxY,d=b.shownBounds_.minX,e=d<=a.x&&a.x<=b.shownBounds_.maxX;if(!e&&d<0){var f=b.gridWidth_[b.shownBounds_.z];e=d+f<=a.x&&a.x<=f-1}return c&&e},MarkerManager.prototype.onMarkerMoved_=function(a,b,c){var d=this,e=d.maxZoom_,f=!1,g=d.getTilePoint_(b,e,GSize.ZERO),h=d.getTilePoint_(c,e,GSize.ZERO);while(e>=0&&(g.x!=h.x||g.y!=h.y)){var i=d.getGridCellNoCreate_(g.x,g.y,e);i&&d.removeFromArray(i,a)&&d.getGridCellCreate_(h.x,h.y,e).push(a),e==d.mapZoom_&&(d.isGridPointVisible_(g)?d.isGridPointVisible_(h)||(d.removeOverlay_(a),f=!0):d.isGridPointVisible_(h)&&(d.addOverlay_(a),f=!0)),g.x=g.x>>1,g.y=g.y>>1,h.x=h.x>>1,h.y=h.y>>1,--e}f&&d.notifyListeners_()},MarkerManager.prototype.removeMarker=function(a){var b=this,c=b.maxZoom_,d=!1,e=a.getPoint(),f=b.getTilePoint_(e,c,GSize.ZERO);while(c>=0){var g=b.getGridCellNoCreate_(f.x,f.y,c);g&&b.removeFromArray(g,a),c==b.mapZoom_&&b.isGridPointVisible_(f)&&(b.removeOverlay_(a),d=!0),f.x=f.x>>1,f.y=f.y>>1,--c}d&&b.notifyListeners_()},MarkerManager.prototype.addMarkers=function(a,b,c){var d=this.getOptMaxZoom_(c);for(var e=a.length-1;e>=0;e--)this.addMarkerBatch_(a[e],b,d);this.numMarkers_[b]+=a.length},MarkerManager.prototype.getOptMaxZoom_=function(a){return a!=undefined?a:this.maxZoom_},MarkerManager.prototype.getMarkerCount=function(a){var b=0;for(var c=0;c<=a;c++)b+=this.numMarkers_[c];return b},MarkerManager.prototype.addMarker=function(a,b,c){var d=this,e=this.getOptMaxZoom_(c);d.addMarkerBatch_(a,b,e);var f=d.getTilePoint_(a.getPoint(),d.mapZoom_,GSize.ZERO);d.isGridPointVisible_(f)&&b<=d.shownBounds_.z&&d.shownBounds_.z<=e&&(d.addOverlay_(a),d.notifyListeners_()),this.numMarkers_[b]++},GBounds.prototype.containsPoint=function(a){var b=this;return b.minX<=a.x&&b.maxX>=a.x&&b.minY<=a.y&&b.maxY>=a.y},MarkerManager.prototype.getGridCellCreate_=function(a,b,c){var d=this.grid_[c];a<0&&(a+=this.gridWidth_[c]);var e=d[a];if(!e)return e=d[a]=[],e[b]=[];var f=e[b];return f?f:e[b]=[]},MarkerManager.prototype.getGridCellNoCreate_=function(a,b,c){var d=this.grid_[c];a<0&&(a+=this.gridWidth_[c]);var e=d[a];return e?e[b]:undefined},MarkerManager.prototype.getGridBounds_=function(a,b,c,d){b=Math.min(b,this.maxZoom_);var e=a.getSouthWest(),f=a.getNorthEast(),g=this.getTilePoint_(e,b,c),h=this.getTilePoint_(f,b,d),i=this.gridWidth_[b];if(f.lng()<e.lng()||h.x<g.x)g.x-=i;h.x-g.x+1>=i&&(g.x=0,h.x=i-1);var j=new GBounds([g,h]);return j.z=b,j},MarkerManager.prototype.getMapGridBounds_=function(){var a=this;return a.getGridBounds_(a.map_.getBounds(),a.mapZoom_,a.swPadding_,a.nePadding_)},MarkerManager.prototype.onMapMoveEnd_=function(){var a=this;a.objectSetTimeout_(this,this.updateMarkers_,0)},MarkerManager.prototype.objectSetTimeout_=function(a,b,c){return window.setTimeout(function(){b.call(a)},c)},MarkerManager.prototype.refresh=function(){var a=this;a.shownMarkers_>0&&a.processAll_(a.shownBounds_,a.removeOverlay_),a.processAll_(a.shownBounds_,a.addOverlay_),a.notifyListeners_()},MarkerManager.prototype.updateMarkers_=function(){var a=this;a.mapZoom_=this.map_.getZoom();var b=a.getMapGridBounds_();if(b.equals(a.shownBounds_)&&b.z==a.shownBounds_.z)return;b.z!=a.shownBounds_.z?(a.processAll_(a.shownBounds_,a.removeOverlay_),a.processAll_(b,a.addOverlay_)):(a.rectangleDiff_(a.shownBounds_,b,a.removeCellMarkers_),a.rectangleDiff_(b,a.shownBounds_,a.addCellMarkers_)),a.shownBounds_=b,a.notifyListeners_()},MarkerManager.prototype.notifyListeners_=function(){GEvent.trigger(this,"changed",this.shownBounds_,this.shownMarkers_)},MarkerManager.prototype.processAll_=function(a,b){for(var c=a.minX;c<=a.maxX;c++)for(var d=a.minY;d<=a.maxY;d++)this.processCellMarkers_(c,d,a.z,b)},MarkerManager.prototype.processCellMarkers_=function(a,b,c,d){var e=this.getGridCellNoCreate_(a,b,c);if(e)for(var f=e.length-1;f>=0;f--)d(e[f])},MarkerManager.prototype.removeCellMarkers_=function(a,b,c){this.processCellMarkers_(a,b,c,this.removeOverlay_)},MarkerManager.prototype.addCellMarkers_=function(a,b,c){this.processCellMarkers_(a,b,c,this.addOverlay_)},MarkerManager.prototype.rectangleDiff_=function(a,b,c){var d=this;d.rectangleDiffCoords(a,b,function(b,e){c.apply(d,[b,e,a.z])})},MarkerManager.prototype.rectangleDiffCoords=function(a,b,c){var d=a.minX,e=a.minY,f=a.maxX,g=a.maxY,h=b.minX,i=b.minY,j=b.maxX,k=b.maxY;for(var l=d;l<=f;l++){for(var m=e;m<=g&&m<i;m++)c(l,m);for(var m=Math.max(k+1,e);m<=g;m++)c(l,m)}for(var m=Math.max(e,i);m<=Math.min(g,k);m++){for(var l=Math.min(f+1,h)-1;l>=d;l--)c(l,m);for(var l=Math.max(d,j+1);l<=f;l++)c(l,m)}},MarkerManager.prototype.removeFromArray=function(a,b,c){var d=0;for(var e=0;e<a.length;++e)if(a[e]===b||c&&a[e]==b)a.splice(e--,1),d++;return d},setTimeout("map()",300)